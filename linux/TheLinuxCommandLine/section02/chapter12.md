# 第十二章: VI简介 #

## 12.1 为什么要学习vi ##

学习vi的三条理由:

1. vi总是可用的, POSIX要求系统必须配备vi.
2. vi是轻量级的软件, 运行速度快, 而且非常利于打字.
3. 用户不想被Linux和UNIX用户蔑视, 笑~.

## 12.2 VI背景 ##

1976年Bill Joy写出了vi的第一个版本, 而现在大多数Linux发行版上配备的都是vi的加强版-- vim, 然后vim的硬链接指向Linux系统的vi名称.

## 12.3 启动和退出vi ##

输入以下命令启动和退出vi:

```
# 启动
vi
# 退出
:q
:q!
```
如果用户不能确定vi所处的状态, 可以按两次Esc键返回初始状态.

## 12.4 编辑模式 ##

vi是一个模态编辑器, 启动后进入的是命令模式, 在此模式中键盘上的每一个按键都代表一条命令.

### 12.4.1 进入插入模式 ###

可以在命令模式下按下I(或i)键进入插入模式, 现在就可以进行输入操作.

### 12.4.2 保存工作 ###

在命令模式下按下 [:] 键, 然后输入w键则将内容写入硬盘.

## 12.5 移动光标 ##

在命令模式下, vi的光标移动命令如下:

| 快捷键 | 作用 | 常用度 | 附加说明 |
|:---------|:-------|:------:|:--------|
| h或左键头 | 左移一个字符 | 常用 | 可用数字+按钮移动多次 |
| j或下箭头 | 下移一个字符 | 常用 | 同上 |
| k或上箭头 | 上移一个字符 | 常用 | 同上 |
| l或右键头 | 右移一个字符 | 常用 | 同上 |
| [Ctrl] + [f] | 屏幕向下一页 | 常用 | 相当于[PageDown] |
| [Ctrl] + [b] | 屏幕向上一页 | 常用 | 相当于[PageUp] |
| [Ctrl] + [d] | 屏幕向下半页 | 一般 |   |
| [Ctrl] + [u] | 屏幕向上半页 | 一般 |   |
| + | 移动到下一列开始 | 一般 |   |
| - | 移动到上一列开始 | 一般 |   |
| n &lt;space&gt; | 后移n个字符 | 一般 | 相当于[n &lt;j&gt;] |
| 0或[Home] | 移动到这一行的开始 | 常用 |   |
| $或[End] | 移动到这一行的结束 | 常用 |   |
| H | 移动到该屏最上方行的第一个字符 | 一般 |   |
| M | 移动到该屏中间行的第一个字符 | 一般 |   |
| L | 移动到该屏最下方行的第一个字符 | 一般 |   |
| G | 移动到该文件的最后一行的第一个字符 | 常用 |   |
| nG | 移动到该文件的第n行 | 常用 | n为数字 |
| gg | 移动到该文件的第1行 | 常用 | 相当于1G |
| n &lt;Enter&gt; | 向下移动n行 | 常用 | 相当于nj |
| W | 到下一个单词或标点的开始处 | 一般 |  |
| WW | 到下一个单词的开头, 忽略标点 | 一般 |  |
| B | 到上一个单词或标点的开始处 | 一般 |  |
| BB | 到上一个单词的开头, 忽略标点 | 一般 |  |

## 12.6 基本编辑 ##

插入, 删除, 剪切和复制等构成了基本的文本编辑操作, 同时vi以命令模式下的u键支持对最后一步操作的撤销操作.

### 12.6.1 添加文本 ###

进入编辑模式的命令如下:

| 快捷键 | 作用 | 常用度 | 附加说明 |
|:---------|:-------|:------:|:--------|
| i | 从光标所在位置插入 | 常用 |   |
| I | 从光标所在行第一个非空字符处插入 | 常用 |   |
| a | 从光标所在位置下一个字符处插入 | 常用 |   |
| A | 从光标所在行的最后一个字符后插入 | 常用 |   |
| o | 从光标所在行的下一行插入新行 | 常用 | 小写字母o |
| O | 从光标所在行的上一行插入新行 | 常用 | 大写字母O |
| r | 取代光标所在字符一次 | 常用 |   |
| R | 一直进行取代 | 常用 |   |
| [Esc] | 退出编辑模式，回到一般模式 | 常用 | Escape键 |

### 12.6.2 插入一行 ###

可以通过在文本中重开一行的方式来插入文本, 即在两行现存的文字中插入空白行并进入插入模式:

| 命令 | 开行 |
|:--|:--|
| o | 当前行的上方 |
| O | 当前行的下方 |

### 12.6.3 删除文本 ###

| 快捷键 | 作用 | 常用度 | 附加说明 |
|:---------|:-------|:------:|:--------|
| x | 向后删除一个字符 | 常用 | 相当于[del] |
| X | 向前删除一个字符 | 常用 | 相当于[backspace] |
| nx | 向后删除n个字符 | 常用 | n为数字 |
| dd | 删除光标所在行 | 常用 |   |
| ndd | 向下删除n行 | 常用 | n为数字 |
| d1G | 删除光标所在行到第1行的数据 | 一般 |   | 
| dG | 删除光标所在行到最后1行的数据 | 一般 |   |
| dnG | 删除光标所在行到第n行的数据 | 一般 |   |
| d$ | 删除光标所在字符到该行最后一个字符 | 常用 |   |
| d0 | 删除光标所在字符到该行第一个字符 | 常用 |   |
| d^ | 删除光标所在字符到该行第一个非空字符 | 常用 |   |
| c | 重复删除多个数据 | 一般 | 例如向下删除10行, [10cj] |
| . | 重复前一个动作 | 常用 | 即小数点 |

### 12.6.4 剪切, 复制和粘贴文本 ###

| 快捷键 | 作用 | 常用度 | 附加说明 |
|:---------|:-------|:------:|:--------|
| yy | 复制光标所在行 | 常用 |   |
| nyy | 向下复制n行 | 常用 | n为数字 |
| y1G | 复制光标所在行到第一行数据 | 一般 |   |
| ynG | 复制光标所在行到第n行数据 | 一般 |   |
| yG | 复制光标所在行到最后一行数据 | 一般 |   |
| y0 | 复制光标所在字符到该行第一个字符 | 常用 |   |
| y$ | 复制光标所在字符到该行最后一个字符 | 常用 |   |
| yW | 复制光标所在字符到该行下一个单词的开始 | 常用 |   |
| y^ | 复制光标所在字符到该行下一个非空字符 | 常用 |   |
| p | 在光标下一行粘贴 | 常用 |   |
| P | 在光标上一行粘贴 | 常用 |   |
| u | 撤销前一个动作 | 常用 |   |
| [Ctrl] + [r] | 重复前一个动作 | 常用 |   |
| . | 重复前一个动作 | 常用 | 即小数点 |

### 12.6.5 合并行 ###

| 快捷键 | 作用 | 常用度 | 附加说明 |
|:---------|:-------|:------:|:--------|
| J | 将光标所在行与下一行合并 | 常用 |   |

## 12.7 查找和替换 ##

### 12.7.1 行内搜索 ###

命令f在行内进行搜索, 并将光标移动到搜索到的下一个指定字符, 例如 fa 移动到本行的下一个a字符, 输入分号可以重复上一次搜索.

### 12.7.2 搜索整个文件 ###

| 快捷键                | 作用                                                       | 常用度   | 附加说明                      |
| :---------            | :-------                                                   | :------: | :--------                     |
| /word                 | 向下查找单词                                               | 常用     | 从光标位置开始                |
| ?word                 | 向上查找单词                                               | 常用     | 同上                          |
| n                     | 重复前一个查找动作                                         | 常用     |                               |
| N                     | 反向重复前一个查找动作                                     | 常用     | 与n相反                       |

### 12.7.3 全局搜索和替换 ###

| 快捷键                | 作用                                                       | 常用度   | 附加说明                      |
| :---------            | :-------                                                   | :------: | :--------                     |
| :n1,n2s/word1/word2/g | 在第n1与n2行查找word1并替换为word2                         | 常用     | 例如[:100,200s/vbird/VBIRD/g] |
| :1,$s/word1/word2/g   | 在第1行与最后一行中查找word1并替换为word2                  | 常用     | 例如[:1,$s/vbird/VBIRD/g]     |
| :1,$s/word1/word2/gc  | 在第1行与最后一行中查找word1并替换为word2,替换时需用户确认 | 常用     | 例如[:1,$s/vbird/VBIRD/gc]    |

最后的g字符指定全局替换, 如果没有则只替换每行的第一个符合条件的实例. c指定需要用户确定, 用户的可用回答命令如下:

| 功能键 | 行为 |
|:--|:--|
| y | 执行替换 |
| n | 跳过此次替换 |
| a | 执行此次替换和之后的所有替换 |
| q或者ESC | 停止替换 |
| l | 执行此次替换并退出替换, 是last的缩写 |
| Ctrl-E, Ctrl-Y | 向上和向下滚动, 用户查看替换处的上下文 |

## 12.8 编辑多个文件 ##

使用以下命令编辑多个文件:

```
vi file...
```

### 12.8.1 切换文件 ###

| 快捷键 | 作用 | 常用度 | 附加说明 |
|:---------|:-------|:------:|:--------|
| :n | 编辑下一个文件 | 一般 |   |
| :N | 编辑上一个文件 | 一般 |   |
| :files | 列出所有打开的文件 | 一般 |   |
| :buffers | 查看正在编辑的文件列表 | 一般 |
| :buffers n | 跳到buffer编号对应的文件 | 一般 |
| :e filename | 打开文件进行编辑 | 一般 |
| :sp [filename] | 开启新窗口 | 一般 | 如果存在[filename]则开启新文件 |
| [Ctrl] + w + j/下箭头 | 移动光标到下方窗口 | 一般 | 先按下[Ctrl],然后按下[w]再放开所有键,再按下j或下箭头 |
| [Ctrl] + w + k/上箭头 | 移动光标到上方窗口 | 一般 | 按下方式基本同上 |
| [Ctrl] + w + q | 结束并离开 | 一般 | 等同与:q |

### 12.8.2 载入更多的文件 ###

| 快捷键 | 作用 | 常用度 | 附加说明 |
|:---------|:-------|:------:|:--------|
| :e filename | 打开文件进行编辑 | 一般 |  |
| :ez filename | 打开文件进行编辑 | 一般 | 与上条命令的不同是此buffer不能使用:n 切换, 需使用buffer编号 |

### 12.8.3 文件之间的内容复制 ###

使用之前的复制粘贴命令即可以在多个文件之间进行内容复制.

### 12.8.4 插入整个文件 ###

| 快捷键 | 作用 | 常用度 | 附加说明 |
|:---------|:-------|:------:|:--------|
| :r filename | 将指定的文件内容插入到光标位置之前 | 一般 |  |

## 12.9 保存工作 ##

| 快捷键 | 作用 | 常用度 | 附加说明 |
|:---------|:-------|:------:|:--------|
| :w | 将文件保存到磁盘 | 常用 |   |
| :w! | 强制保存到磁盘 | 常用 | 与权限等相关 |
| :q | 退出vi | 常用 |   |
| :q! | 强制退出vi | 常用 | 在不想保存已修改文件时使用 |
| :wq | 保存文件并退出vi | 常用 | 不能保存时可使用[:wq!] |
| ZZ | 保存文件(有修改)并退出vi | 常用 | 大写字母Z |
| :w [filename] | 保存到文件[filename] | 常用 |   |
| :r [filename] | 添加文件[filename]的内容 | 一般 | 将文件[filename]的内容添加到当前文件光标所在行后 |
| :n1,n2 w [filename] | 将n1到n2行点内容保存到文件[filename] | 一般 |   |
| :! command | 暂时离开命令模式并执行command,显示结果 | 一般 | 例如[:! ls /home]，在vi中查看/home目录内容 |

## 12.10 更多命令 ##

### 12.10.1 区块选择 ###

| 快捷键 | 作用 | 常用度 | 附加说明 |
|:---------|:-------|:------:|:--------|
| v | 字符选择，将光标经过的地方反白选择 | 一般 | 小写字母v |
| V | 行选择，将光标经过的行反白选择 | 一般 | 大写字母V |
| [Ctrl] + [v] | 区块选择，长方形 | 一般 |   |
| y | 复制反白的区域 | 一般 |   |
| d | 删除反白的区域 | 一般 |   |

### 12.10.2 列编辑 ###

依次执行以下命令：

1. 使用[Ctrl] + v进行区块选择，选取操作的列;
2. 按下大写的I进入编辑模式，进行编辑;
3. 编辑完成后按下[Esc]返回一般模式，即可看到相应的列以插入目标内容;

### 12.10.3 折叠命令 ###

#### 12.10.3.1 简介 ####

折叠功能即将一部分相关的文本收缩到一行,常用于浏览较长的相关文本.

折叠功能可以在Visual模式中选中一些文本,然后使用**zf**命令进行折叠; 
也可以在命令模式下, 使用: 开始行号,结束行号 folder命令进行折叠.

例如:

    110,120 fo                  // 折叠110到120行  
    110,120 >                   // 缩进110到120行
    110,120 yank                // 复制110到120行到默认寄存器
    110,120 yank x              // 复制110到120行到x寄存器

#### 12.10.3.2 折叠方法 ####

有以下6种具体的折叠方式:

  * manual: 手工定义折叠, 默认, 不常用
  * indent: 缩进折叠方式, 相同的缩进被折叠, 常用
  * syntax: 语法高亮折叠, 不常用
  * marker: 标记折叠, 常用
  * diff: 对没有更改的文本进行折叠
  * expr: 使用表达式定义折叠

注意: 每种折叠方式都不兼容

#### 12.10.3.3 折叠命令 ####

| 快捷键 | 描述 |
|:--:|:--|
| zf | 创建折叠 |
| zF | 在当前行创建折叠, 创建一对折叠符号, 可以向里面填写内容 |
| :5,10fo | 折叠5-10行 |
| zd | 删除光标下的折叠 |
| zD | 删除光标下的折叠, 以及嵌套的折叠 |
| zE | 删除窗口下所有折叠 |
| zo | 打开光标下的折叠 |
| zO | 打开光标下的折叠, 以及嵌套的折叠 |
| zc | 关闭光标下的折叠 |
| zC | 关闭光标下的折叠, 以及嵌套的折叠 |
| za | 当折叠关闭时打开, 当折叠打开时关闭 |
| zA | 类似于za, 对嵌套折叠生效 |
| zv | 打开当前光标所在折叠，仅打开足够的折叠使光标所在的行不被折叠 |
| zr/zm | 一层一层打开折叠和一层一层关闭折叠，这两个命令会递减和递增一个叫foldlevel的变量。如果你发现zm和zr不灵了，那有可能是你连续按的zr或zm次数多了，只要多按几次让foldlevel回到正常状态即可。执行以下zR和zM也可直接让foldlevel回到正常状态。 |
| zR/zM | 打开所有折叠，设置foldlevel为最高级别。关闭所有折叠，设置foldlevel为0。 |
| [z | 到当前打开折叠的开始。如果已在开始处，移到包含这个折叠的折叠开始处 |
| ]z | 到当前打开折叠的结束。如果已在结束处，移到包含这个折叠的折叠结束处 |
| zj | 把光标移动到下一个折叠的开始处 | 
| zk | 把光标移动到前一个折叠的结束处 |

#### 12.10.3.4 折叠实例 ####

以下为一个折叠的例子:

  * 5G: 光标跳到第5行
  * zf10G: 折叠5-10行
  * zR: 打开所有折叠
  * zM: 关闭所有折叠
  * zE: 删除所有折叠标签

## 12.11 扩展阅读 ##

即使把这章所学的内容都加起来, 我们也只是学了 vi 和 vim 的一点儿皮毛而已. 这里有一些在线的资料, 你可以用来继续 vi 学习之旅.

- <学习 vi 编辑器> 是一本来自于 Wikipedia 的 Wikibook, 是一本关于 vi 的简要指南, 并介绍了几个类似 vi 的程序, 其中包括 vim. 它可以在以下链接中得到:

[http://en.wikibooks.org/wiki/Vi](http://en.wikibooks.org/wiki/Vi)

- <The Vim Book>－vim 项目, 一本570页的书籍, 包含了几乎所有的 vim 特性. 你能在下面链接中找到它:

[ftp://ftp.vim.org/pub/vim/doc/book/vimbook-OPL.pdf](ftp://ftp.vim.org/pub/vim/doc/book/vimbook-OPL.pdf)

- Wikipedia 上关于 Bill Joy 的文章, vi 的创始人:

[http://en.wikipedia.org/wiki/Bill_Joy](http://en.wikipedia.org/wiki/Bill_Joy)

- Wikipedia 上关于 Bram Moolenaar 的文章, vim 的作者:

[http://en.wikipedia.org/wiki/Bram_Moolenaar](http://en.wikipedia.org/wiki/Bram_Moolenaar)
